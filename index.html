<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <title>Supporting BFCached Documents</title>
  <meta content="UD" name="w3c-status">
  <link href="https://www.w3.org/StyleSheets/TR/2021/W3C-UD" rel="stylesheet">
  <meta content="Bikeshed version d29f71adb, updated Wed Jul 19 11:08:56 2023 -0700" name="generator">
  <link href="https://w3ctag.github.io/bfcache-guide/" rel="canonical">
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */

/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    white-space: pre;
    display: inline-block;
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: .5em;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
}

.dfn-paneled[role="button"] { cursor: pointer; }
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-selflinks */

:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">Supporting BFCached Documents</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types#UD">Unofficial Proposal Draft</a>, <time class="dt-updated" datetime="2023-07-31">31 July 2023</time></p>
   <details open>
    <summary>More details about this document</summary>
    <div data-fill-with="spec-metadata">
     <dl>
      <dt>This version:
      <dd><a class="u-url" href="https://w3ctag.github.io/bfcache-guide/">https://w3ctag.github.io/bfcache-guide/</a>
      <dt>Issue Tracking:
      <dd><a href="https://github.com/w3ctag/bfcache-guide/issues/">GitHub</a>
      <dt class="editor">Editor:
      <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:rakina@google.com">Rakina Zata Amni</a> (<a class="p-org org" href="https://www.google.com/">Google</a>)
     </dl>
    </div>
   </details>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> © 2023 <a href="https://www.w3.org/">World Wide Web Consortium</a>. <abbr title="World Wide Web Consortium">W3C</abbr><sup>®</sup> <a href="https://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>, <a href="https://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a> and <a href="https://www.w3.org/Consortium/Legal/copyright-software" rel="license" title="W3C Software and Document License">permissive document license</a> rules apply. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>This document gives guidance on how to write specifications that

    handle BFCached documents, where a document is kept alive (instead of
    getting destroyed) after navigation, and potentially gets reused on
    future navigations back to the document.</p>
  </div>
  <h2 class="no-num no-toc no-ref heading settled" id="sotd"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> <em>This section describes the status of this document at the time of its
    publication. A list of current <abbr title="World Wide Web Consortium">W3C</abbr> publications and the
    latest revision of this technical report can be found in the <a href="https://www.w3.org/TR/"><abbr title="World Wide Web
    Consortium">W3C</abbr> technical reports index</a>.</em> </p>
   <p> This document was published by the <a href="https://www.w3.org/2001/tag/">W3C Technical Architecture Group
    (TAG)</a> as an Unofficial Proposal Draft.
    Publication as an Unofficial Proposal Draft does not imply endorsement by <abbr title="World Wide Web Consortium">W3C</abbr> and its Members. This is a
    draft document and may be updated, replaced or obsoleted by other documents
    at any time. It is inappropriate to cite this document as other than work in
    progress. </p>
   <p></p>
   <p> Feedback and comments on this specification are welcome. Please <a href="https://github.com/w3ctag/bfcache-guide/issues">file an issue</a> in this document’s <a href="https://github.com/w3ctag/bfcache-guide/">GitHub repository</a>. </p>
   <p> This document is governed by the <a href="https://www.w3.org/2019/Process-20190301/" id="w3c_process_revision">1 March 2019 W3C Process
    Document</a>. </p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li><a href="#intro"><span class="secno">1</span> <span class="content">Introduction</span></a>
    <li>
     <a href="#when-to-use"><span class="secno">2</span> <span class="content">When should features care about BFCache?</span></a>
     <ol class="toc">
      <li>
       <a href="#api-design-guide"><span class="secno">2.1</span> <span class="content">API Design Guidance</span></a>
       <ol class="toc">
        <li><a href="#gate-fully-active"><span class="secno">2.1.1</span> <span class="content">Gate actions with <span>fully active</span> checks</span></a>
        <li><a href="#listen-fully-active"><span class="secno">2.1.2</span> <span class="content">Listen for changes to <span>fully active</span> status</span></a>
        <li><a href="#omit-non-fully-active"><span class="secno">2.1.3</span> <span class="content">Omit non-<span>fully active</span> documents from APIs that span multiple documents</span></a>
        <li><a href="#discard"><span class="secno">2.1.4</span> <span class="content">Discard non-<span>fully active</span> documents for situations that can’t be supported</span></a>
        <li><a href="#per-document-state"><span class="secno">2.1.5</span> <span class="content">Be aware that per-document state/data might persist after navigation</span></a>
        <li><a href="#non-synchronous-steps"><span class="secno">2.1.6</span> <span class="content">Be aware that navigations can happen between steps running <span>in parallel</span></span></a>
       </ol>
      <li><a href="#antipatterns"><span class="secno">2.2</span> <span class="content">Antipatterns</span></a>
     </ol>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="intro"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#intro"></a></h2>
   <p>Browser implementations may have a back/forward cache, or "BFCache" for short.
After a user navigates away from a document, the document might be cached in a non-<a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active">fully active</a> state,
and might be reused when the user navigates back.
In the past, many APIs have missed specifying support for non-fully active documents,
making them hard to support in various user agents that cache pages in the BFCache,
effectively making the user experience of navigating back and forth less optimal,
or even introducing breakages or differences in behavior in various different implementations of BFCache.</p>
   <p>By specifying BFCache support for new APIs,
web developers do not need to choose between using the API and giving a more performant browsing experience through instant history navigations.
Going forward, <b>all features should have BFCache support by default</b>,
as documents are actually BFCached on navigation instead of getting destroyed for a sizable chunk of navigations.</p>
   <p class="note" role="note"><span class="marker">Note:</span> It is possible for a document to become non-<a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active①">fully active</a> for other reasons
not related to BFcaching, such as when the iframe holding the document gets
detached. Some advice below might not be relevant for those cases, since the
document will never return to <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active②">fully active</a> again.</p>
   <h2 class="heading settled" data-level="2" id="when-to-use"><span class="secno">2. </span><span class="content">When should features care about BFCache?</span><a class="self-link" href="#when-to-use"></a></h2>
   <p>If your API does things that fall into <b>any</b> of the below categories:</p>
   <ul>
    <li data-md>
     <p>Interacts with a document from the "outside" (e.g. sends information to a
document)</p>
    <li data-md>
     <p>Makes cross-document interaction/resource sharing possible (e.g. holding
locks)</p>
    <li data-md>
     <p>May malfunction when a document is kept in a non-<a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active③">fully active</a> (BFCached) state (instead of getting destroyed) after the user navigates
away from it or gets restored (e.g. expects that a state saved in the
document won’t span multiple navigations)</p>
   </ul>
   <p>You should specify how it works with non-<a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active④">fully active</a> (BFCached)
documents, following the guidelines below.
See also the <a href="#antipatterns">§ 2.2 Antipatterns</a> section to avoid common antipatterns.</p>
   <h3 class="heading settled" data-level="2.1" id="api-design-guide"><span class="secno">2.1. </span><span class="content">API Design Guidance</span><a class="self-link" href="#api-design-guide"></a></h3>
   <h4 class="heading settled" data-level="2.1.1" id="gate-fully-active"><span class="secno">2.1.1. </span><span class="content">Gate actions with <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active⑤">fully active</a> checks</span><a class="self-link" href="#gate-fully-active"></a></h4>
   <p>When performing actions that might update the state of a document,
be aware that the document might not be <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active⑥">fully active</a> and is considered as "non-existent" from the user’s perspective.
This means they should not receive updates or perform actions.</p>
   <p class="note" role="note"><span class="marker">Note:</span> It is possible for a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active⑦">fully active</a> document to be perceived as "non-existent" by users,
such as when the document is <a href="https://wicg.github.io/nav-speculation/prerendering.html">displaying prerendered content</a>.
These documents might behave differently than non-<a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active⑧">fully active</a> documents,
and the guidelines here might not be applicable to them,
as it is written only for handling non-<a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active⑨">fully active</a> (BFCached) documents.</p>
   <p>In many cases,
anything that happens while the document is not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active①⓪">fully active</a> should be treated as if it never happened.
If it makes more sense to "update" a document to ensure it does not hold  stale information
after it becomes <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active①①">fully active</a> again, consider the <a href="#listen-fully-active">§ 2.1.2 Listen for changes to fully active status</a> pattern below.</p>
   <div class="example" id="example-be5edf6e"><a class="self-link" href="#example-be5edf6e"></a> APIs that periodically send information updates,
  such as Geolocation API’s <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/geolocation-api/#dom-geolocation-watchposition" id="ref-for-dom-geolocation-watchposition">watchPosition()</a></code> should not send updates if the document is no longer fully active.
  They also should not queue those updates to arrive later.
  Instead, they should only resume sending updates when the document becomes active again,
  possibly sending one update with the latest information then. </div>
   <p class="note" role="note"><span class="marker">Note:</span> If the actions are already protected by certain checks that can only be satisfied if the document is <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active①②">fully active</a>,
such as checking if the top-level browsing context has <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/interaction.html#system-focus" id="ref-for-system-focus">system focus</a>,
fully active checks might not be needed.
However, be careful of certain checks like transient user activation,
which can be true even if a document is not fully active.
See also the <a href="#per-document-state">§ 2.1.5 Be aware that per-document state/data might persist after navigation</a> section.</p>
   <h4 class="heading settled" data-level="2.1.2" id="listen-fully-active"><span class="secno">2.1.2. </span><span class="content">Listen for changes to <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active①③">fully active</a> status</span><a class="self-link" href="#listen-fully-active"></a></h4>
   <p>When a document goes from <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active①④">fully active</a> to non-<a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active①⑤">fully active</a>,
it should be treated similarly to the way discarded documents are treated.
The document must not retain exclusive access to shared resources
and must ensure that no new requests are issued
and that connections that allow for new incoming requests are terminated.
When a document goes from non-<a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active①⑥">fully active</a> to <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active①⑦">fully active</a> again,
it can restore connections if appropriate.</p>
   <p>To listen to changes from <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active①⑧">fully active</a> to non-<a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active①⑨">fully active</a>,
add a step in <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-lifecycle.html#unloading-document-cleanup-steps" id="ref-for-unloading-document-cleanup-steps">unloading document cleanup steps</a>.
Meanwhile, to listen to changes from non-<a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active②⓪">fully active</a> to <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active②①">fully active</a>,
add a step to <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#reactivate-a-document" id="ref-for-reactivate-a-document">reactivate</a> a document.</p>
   <p>While web authors can manually do cleanup (e.g. release the resources, sever connections)
from within the <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/indices.html#event-pagehide" id="ref-for-event-pagehide">pagehide</a></code> event and restore them from the <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/indices.html#event-pageshow" id="ref-for-event-pageshow">pageshow</a></code> event themselves,
doing this automatically from the API design allows the document to be kept alive after navigation by default,
and is more likely to lead to well-functioning web applications.</p>
   <div class="example" id="example-76ebae04"><a class="self-link" href="#example-76ebae04"></a> APIs that create live connections can pause/close the connection and possibly resume/reopen it later.
  It’s also possible to let the connection stay open to complete existing ongoing requests,
  and later update the document with the result when it gets restored, if appropriate (e.g.
  resource loads). </div>
   <div class="example" id="example-1dfbe459"><a class="self-link" href="#example-1dfbe459"></a> APIs that hold non-exclusive resources
  may be able to release the resource when the document becomes not fully active,
  and re-acquire them when it becomes <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active②②">fully active</a> again
  (Screen Wake Lock API is already <a href="https://w3c.github.io/screen-wake-lock/#handling-document-loss-of-full-activity">doing</a> the first part). </div>
   <p class="note" role="note"><span class="marker">Note:</span> this might not be appropriate for all types of resources,
e.g. if an exclusive lock is held,
we cannot just release it and reacquire when <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active②③">fully active</a> since another page could then take that lock.
If there is an API to signal to the page that this has happened,
it may be acceptable but beware that if the only time this happens is with BFCache,
then it’s likely many pages are not prepared for it. If it is not possible to support BFCache,
follow the <a href="#discard">§ 2.1.4 Discard non-fully active documents for situations that can’t be supported</a> pattern described below.</p>
   <p>Additionally, when a document becomes <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active②④">fully active</a> again,
it can be useful to update it with the current state of the world,
if anything has changed while it is in the non-<a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active②⑤">fully active</a> state.
However, care needs to be taken with events that occurred while in the BFCache.
When not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active②⑥">fully active</a>, for some cases, all events should be dropped,
in some the latest state should be delivered in a single event,
in others it may be appropriate to queue events or deliver a combined event.
The correct approach is case by case and should consider privacy,
correctness, performance and ergonomics.</p>
   <p class="note" role="note"><span class="marker">Note:</span> Making sure the latest state is sent to a document that becomes <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active②⑦">fully active</a> again is especially important when retrofitting existing APIs.
This is because current users of these APIs expect to always have the latest information.
Dropping state updates can leave the document with stale information,
which can lead to unexpected and hard-to-detect breakage of existing sites.</p>
   <div class="example" id="example-32a4ab83"><a class="self-link" href="#example-32a4ab83"></a> The <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/gamepad/#dfn-gamepadconnected" id="ref-for-dfn-gamepadconnected">gamepadconnected</a></code> event
  can be sent to a document that becomes <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active②⑧">fully active</a> again
  if a gamepad is connected while the document is not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active②⑨">fully active</a>.
  If the gamepad was repeatedly connected and disconnected,
  only the final connected event should be delivered.
  (This is not specified yet, see <a href="https://github.com/w3c/gamepad/issues/149">issue</a>) </div>
   <div class="example" id="example-46b7099c"><a class="self-link" href="#example-46b7099c"></a> For geolocation or other physical sensors,
  no information about what happened while not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active③⓪">fully active</a> should be delivered.
  The events should simply resume from when the document became <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active③①">fully active</a>.
  However, these APIs should check the state when the document becomes <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active③②">fully active</a> again,
  to determine if a status update should be sent (e.g. is the current location far away from the
  location when the document becomes not fully active?), to ensure the document has the latest
  information, as guaranteed by the API normally. </div>
   <div class="example" id="example-3f8cc6e6"><a class="self-link" href="#example-3f8cc6e6"></a> For network connections or streams,
  the data received while not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active③③">fully active</a> should be delivered only
  when the document becomes <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active③④">fully active</a> again,
  but whereas a stream might have created many events with a small amount of data each,
  it could be delivered as smaller number of events with more data in each. </div>
   <h4 class="heading settled" data-level="2.1.3" id="omit-non-fully-active"><span class="secno">2.1.3. </span><span class="content">Omit non-<a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active③⑤">fully active</a> documents from APIs that span multiple documents</span><a class="self-link" href="#omit-non-fully-active"></a></h4>
    Non-<a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active③⑥">fully active</a> documents should not be observable,
so APIs should treat them as if they no longer exist.
They should not be visible to the "outside world" through document-spanning APIs
(e.g. <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/ServiceWorker/#dom-clients-matchall" id="ref-for-dom-clients-matchall">clients.matchAll()</a></code>, <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#dom-opener" id="ref-for-dom-opener">window.opener</a></code>). 
   <p class="note" role="note"><span class="marker">Note:</span> This should be rare since cross-document-spanning APIs are themselves relatively rare.</p>
   <div class="example" id="example-20998cac"><a class="self-link" href="#example-20998cac"></a> <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/web-messaging.html#broadcastchannel" id="ref-for-broadcastchannel">BroadcastChannel</a></code> <a href="https://html.spec.whatwg.org/multipage/web-messaging.html#broadcasting-to-other-browsing-contexts:fully-active">checks</a> for <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active③⑦">fully active</a> before sending messages to other browsing contexts. </div>
   <div class="example" id="example-1a865af0"><a class="self-link" href="#example-1a865af0"></a> <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/ServiceWorker/#dom-clients-matchall" id="ref-for-dom-clients-matchall①">clients.matchAll()</a></code> currently does not distinguish between <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active③⑧">fully active</a> and non-<a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active③⑨">fully active</a> clients,
  but correct implementations should only return <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active④⓪">fully active</a> clients.
  (See <a href="https://github.com/w3c/ServiceWorker/issues/1594">issue</a>) </div>
   <h4 class="heading settled" data-level="2.1.4" id="discard"><span class="secno">2.1.4. </span><span class="content">Discard non-<a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active④①">fully active</a> documents for situations that can’t be supported</span><a class="self-link" href="#discard"></a></h4>
    If supporting non-<a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active④②">fully active</a> documents is not possible for certain cases,
explicitly specify it by <a data-link-type="dfn">discarding the document|</a> if the situation happens after the user navigated away,
or setting the document’s <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#concept-document-salvageable">salvageable</a>)
bit to false if the situation happens before or during the navigation away from the document,
to cause it to be automatically discarded after navigation. 
   <p class="note" role="note"><span class="marker">Note:</span> this should be rare and probably should only be used when retrofitting old APIs,
as new APIs should always strive to work well with BFCache.</p>
   <div class="example" id="example-94d4ddf4"><a class="self-link" href="#example-94d4ddf4"></a> WebSockets <a href="https://html.spec.whatwg.org/#unloading-documents:concept-document-salvageable-7">sets the salvageable bit to false</a> during unload. </div>
   <div class="example" id="example-47c778e3"><a class="self-link" href="#example-47c778e3"></a> Calling <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/ServiceWorker/#dom-clients-claim" id="ref-for-dom-clients-claim">clients.claim()</a></code> should not wait for non-<a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active④③">fully active</a> clients,
  instead it should cause the non-<a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active④④">fully active</a> client documents to be discarded.
  (This is currently not specified, see <a href="https://github.com/w3c/ServiceWorker/issues/1594">issue</a>) </div>
   <h4 class="heading settled" data-level="2.1.5" id="per-document-state"><span class="secno">2.1.5. </span><span class="content">Be aware that per-document state/data might persist after navigation</span><a class="self-link" href="#per-document-state"></a></h4>
    As a document might be reused even after navigation,
be aware that tying something to a document’s lifetime
also means reusing it after navigations.
If this is not desirable,
consider listening to changes to the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active④⑤">fully active</a> state
and doing cleanup as necessary (see the <a href="#listen-fully-active">§ 2.1.2 Listen for changes to fully active status</a> pattern above). 
   <div class="example" id="example-957129a3"><a class="self-link" href="#example-957129a3"></a> <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/interaction.html#sticky-activation" id="ref-for-sticky-activation">Sticky activation</a> is determined by the "last activation timestamp",
  which is tied to a document.
  This means after a user triggers activation once on a document,
  the document will have sticky activation forever,
  even after the user navigated away and back to it again.
  The <a href="https://github.com/whatwg/html/issues/6588#issuecomment-1157244943">discussion</a> around this concluded that this is OK after comparing with other behaviors (e.g. focus),
  but every feature specification should think about this and decide what works best for the feature. </div>
   <h4 class="heading settled" data-level="2.1.6" id="non-synchronous-steps"><span class="secno">2.1.6. </span><span class="content">Be aware that navigations can happen between steps running <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel" id="ref-for-in-parallel">in parallel</a></span><a class="self-link" href="#non-synchronous-steps"></a></h4>
    If steps that run <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel" id="ref-for-in-parallel①">in parallel</a> queue a task that is associated with a document,
you need to be aware that the document might have been navigated away from and (later on) navigated to again.
This can happen while running the steps <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel" id="ref-for-in-parallel②">in parallel</a> and can have happened when the steps in the queued task eventually run.
Since a navigation has happened and a considerable amount of time might have passed between the steps,
the user might not expect some states that are saved in the steps to be preserved. 
   <p class="note" role="note"><span class="marker">Note:</span> In theory, steps that run <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel" id="ref-for-in-parallel③">in parallel</a> ought to be already resilient to changes that might occur between its steps.
However, existing specs might not expect that navigations can occur and the document to be perceived as "gone" by the user in between the steps.</p>
   <p>When writing steps that run <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel" id="ref-for-in-parallel④">in parallel</a>,
consider also listening to changes to the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active④⑥">fully active</a> state
and doing cleanup as necessary or even refrain from running some steps
(see the <a href="#listen-fully-active">§ 2.1.2 Listen for changes to fully active status</a> pattern above).</p>
   <div class="example" id="example-13d9fd30"><a class="self-link" href="#example-13d9fd30"></a> APIs that request permission to the user, or requests user interaction through prompt, etc.,
  should consider re-requesting the user if it detects that the document had become non-fully active. </div>
   <h3 class="heading settled" data-level="2.2" id="antipatterns"><span class="secno">2.2. </span><span class="content">Antipatterns</span><a class="self-link" href="#antipatterns"></a></h3>
   <p>This is basically the reverse of what is mentioned in the design guidance.
When writing specifications, <b>do not do these</b>:</p>
   <ul>
    <li data-md>
     <p>Expect that things kept alive in the document (connections, etc) or that are otherwise tied to the document lifetime
will be automatically destroyed/disconnected/etc on navigation along with document destruction.
This is wrong because documents might be kept alive in the BFCache after navigation,
and can potentially get restored later. 
See these guides on how to handle this:</p>
     <ul>
      <li data-md>
       <p><a href="#gate-fully-active">§ 2.1.1 Gate actions with fully active checks</a></p>
      <li data-md>
       <p><a href="#listen-fully-active">§ 2.1.2 Listen for changes to fully active status</a></p>
     </ul>
    <li data-md>
     <p>Expect that if a document is alive, it is also perceived as alive by the user,
and thus can be treated like any other document.
This is wrong because documents that are BFCached are “alive”,
but they’re actually gone from the perspective of the users (as they have navigated away),
and thus shouldn’t be treated the same way as other documents.
See these guides on how to handle this:</p>
     <ul>
      <li data-md>
       <p><a href="#omit-non-fully-active">§ 2.1.3 Omit non-fully active documents from APIs that span multiple documents</a></p>
      <li data-md>
       <p><a href="#gate-fully-active">§ 2.1.1 Gate actions with fully active checks</a></p>
     </ul>
    <li data-md>
     <p>Expect that a document is only “shown”/navigated to once.
This is wrong because documents can potentially get restored on future history navigations,
and thus the user can navigate to and reuse the same document multiple times with multiple navigations.
See these guides on how to handle this:</p>
     <ul>
      <li data-md>
       <p><a href="#listen-fully-active">§ 2.1.2 Listen for changes to fully active status</a></p>
      <li data-md>
       <p><a href="#per-document-state">§ 2.1.5 Be aware that per-document state/data might persist after navigation</a></p>
      <li data-md>
       <p><a href="#non-synchronous-steps">§ 2.1.6 Be aware that navigations can happen between steps running in parallel</a></p>
     </ul>
   </ul>
  </main>
  <div data-fill-with="conformance">
   <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
   <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
   <p>Conformance requirements are expressed
    with a combination of descriptive assertions
    and RFC 2119 terminology.
    The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
    in the normative parts of this document
    are to be interpreted as described in RFC 2119.
    However, for readability,
    these words do not appear in all uppercase letters in this specification. </p>
   <p>All of the text of this specification is normative
    except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</a> </p>
   <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text
    with <code>class="example"</code>,
    like this: </p>
   <div class="example" id="w3c-example">
    <a class="self-link" href="#w3c-example"></a> 
    <p>This is an example of an informative example. </p>
   </div>
   <p>Informative notes begin with the word “Note”
    and are set apart from the normative text
    with <code>class="note"</code>,
    like this: </p>
   <p class="note" role="note">Note, this is an informative note.</p>
  </div>
<script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[GAMEPAD]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="767d1b0b">gamepadconnected</span>
    </ul>
   <li>
    <a data-link-type="biblio">[GEOLOCATION]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="4de8fec9">watchPosition()</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="a0c4f72a">BroadcastChannel</span>
     <li><span class="dfn-paneled" id="0e3ba9f8">fully active</span>
     <li><span class="dfn-paneled" id="a72449dd">in parallel</span>
     <li><span class="dfn-paneled" id="cbe46402">opener</span>
     <li><span class="dfn-paneled" id="324be8d3">pagehide</span>
     <li><span class="dfn-paneled" id="e5ed7762">pageshow</span>
     <li><span class="dfn-paneled" id="e93b877c">reactivate</span>
     <li><span class="dfn-paneled" id="ca96a59c">sticky activation</span>
     <li><span class="dfn-paneled" id="124a994b">system focus</span>
     <li><span class="dfn-paneled" id="4411082c">unloading document cleanup steps</span>
    </ul>
   <li>
    <a data-link-type="biblio">[SERVICE-WORKERS]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="723fc9da">claim()</span>
     <li><span class="dfn-paneled" id="be123ea4">matchAll()</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
   <dt id="biblio-service-workers">[SERVICE-WORKERS]
   <dd>Jake Archibald; Marijn Kruisselbrink. <a href="https://w3c.github.io/ServiceWorker/"><cite>Service Workers</cite></a>. URL: <a href="https://w3c.github.io/ServiceWorker/">https://w3c.github.io/ServiceWorker/</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-gamepad">[GAMEPAD]
   <dd>Steve Agoston; Matthew Reynolds. <a href="https://w3c.github.io/gamepad/"><cite>Gamepad</cite></a>. URL: <a href="https://w3c.github.io/gamepad/">https://w3c.github.io/gamepad/</a>
   <dt id="biblio-geolocation">[GEOLOCATION]
   <dd>Marcos Caceres; Reilly Grant. <a href="https://w3c.github.io/geolocation-api/"><cite>Geolocation API</cite></a>. URL: <a href="https://w3c.github.io/geolocation-api/">https://w3c.github.io/geolocation-api/</a>
  </dl>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
    const dfnsJson = window.dfnsJson || {};

    function genDfnPanel({dfnID, url, dfnText, refSections, external}) {
        return mk.aside({
            class: "dfn-panel",
            id: `infopanel-for-${dfnID}`,
            "data-for": dfnID,
            "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
            },
            mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
                `Info about the '${dfnText}' ${external?"external":""} reference.`),
            mk.a({href:url}, url),
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({
                                    href: `#${ref.id}`
                                    },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        );
    }

    function genAllDfnPanels() {
        for(const panelData of Object.values(window.dfnpanelData)) {
            const dfnID = panelData.dfnID;
            const dfn = document.getElementById(dfnID);
            if(!dfn) {
                console.log(`Can't find dfn#${dfnID}.`, panelData);
            } else {
                const panel = genDfnPanel(panelData);
                append(document.body, panel);
                insertDfnPopupAction(dfn, panel)
            }
        }
    }

    document.addEventListener("DOMContentLoaded", ()=>{
        genAllDfnPanels();

        // Add popup behavior to all dfns to show the corresponding dfn-panel.
        var dfns = queryAll('.dfn-paneled');
        for(let dfn of dfns) { ; }

        document.body.addEventListener("click", (e) => {
            // If not handled already, just hide all dfn panels.
            hideAllDfnPanels();
        });
    })


    function hideAllDfnPanels() {
        // Turn off any currently "on" or "activated" panels.
        queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>hideDfnPanel(el));
    }

    function showDfnPanel(dfnPanel, dfn) {
        hideAllDfnPanels(); // Only display one at this time.
        dfn.setAttribute("aria-expanded", "true");
        dfnPanel.classList.add("on");
        dfnPanel.style.left = "5px";
        dfnPanel.style.top = "0px";
        const panelRect = dfnPanel.getBoundingClientRect();
        const panelWidth = panelRect.right - panelRect.left;
        if (panelRect.right > document.body.scrollWidth) {
            // Panel's overflowing the screen.
            // Just drop it below the dfn and flip it rightward instead.
            // This still wont' fix things if the screen is *really* wide,
            // but fixing that's a lot harder without 'anchor()'.
            dfnPanel.style.top = "1.5em";
            dfnPanel.style.left = "auto";
            dfnPanel.style.right = "0px";
        }
    }

    function pinDfnPanel(dfnPanel) {
        // Switch it to "activated" state, which pins it.
        dfnPanel.classList.add("activated");
        dfnPanel.style.left = null;
        dfnPanel.style.top = null;
    }

    function hideDfnPanel(dfnPanel, dfn) {
        if(!dfn) {
            dfn = document.getElementById(dfnPanel.getAttribute("data-for"));
        }
        dfn.setAttribute("aria-expanded", "false")
        dfnPanel.classList.remove("on");
        dfnPanel.classList.remove("activated");
    }

    function toggleDfnPanel(dfnPanel, dfn) {
        if(dfnPanel.classList.contains("on")) {
            hideDfnPanel(dfnPanel, dfn);
        } else {
            showDfnPanel(dfnPanel, dfn);
        }
    }

    function insertDfnPopupAction(dfn, dfnPanel) {
        // Find dfn panel
        const panelWrapper = document.createElement('span');
        panelWrapper.appendChild(dfnPanel);
        panelWrapper.style.position = "relative";
        panelWrapper.style.height = "0px";
        dfn.insertAdjacentElement("afterend", panelWrapper);
        dfn.setAttribute('role', 'button');
        dfn.setAttribute('aria-expanded', 'false')
        dfn.tabIndex = 0;
        dfn.classList.add('has-dfn-panel');
        dfn.addEventListener('click', (event) => {
            showDfnPanel(dfnPanel, dfn);
            event.stopPropagation();
        });
        dfn.addEventListener('keypress', (event) => {
            const kc = event.keyCode;
            // 32->Space, 13->Enter
            if(kc == 32 || kc == 13) {
                toggleDfnPanel(dfnPanel, dfn);
                event.stopPropagation();
                event.preventDefault();
            }
        });

        dfnPanel.addEventListener('click', (event) => {
            if (event.target.nodeName == 'A') {
                pinDfnPanel(dfnPanel);
            }
            event.stopPropagation();
        });

        dfnPanel.addEventListener('keydown', (event) => {
            if(event.keyCode == 27) { // Escape key
                hideDfnPanel(dfnPanel, dfn);
                event.stopPropagation();
                event.preventDefault();
            }
        })
    }
}
</script>
<script>/* Boilerplate: script-dfn-panel-json */
window.dfnpanelData = {};
window.dfnpanelData['767d1b0b'] = {"dfnID": "767d1b0b", "url": "https://w3c.github.io/gamepad/#dfn-gamepadconnected", "dfnText": "gamepadconnected", "refSections": [{"refs": [{"id": "ref-for-dfn-gamepadconnected"}], "title": "2.1.2. Listen for changes to fully active status"}], "external": true};
window.dfnpanelData['4de8fec9'] = {"dfnID": "4de8fec9", "url": "https://w3c.github.io/geolocation-api/#dom-geolocation-watchposition", "dfnText": "watchPosition()", "refSections": [{"refs": [{"id": "ref-for-dom-geolocation-watchposition"}], "title": "2.1.1. Gate actions with fully active checks"}], "external": true};
window.dfnpanelData['a0c4f72a'] = {"dfnID": "a0c4f72a", "url": "https://html.spec.whatwg.org/multipage/web-messaging.html#broadcastchannel", "dfnText": "BroadcastChannel", "refSections": [{"refs": [{"id": "ref-for-broadcastchannel"}], "title": "2.1.3. Omit non-fully active documents from APIs that span multiple documents"}], "external": true};
window.dfnpanelData['0e3ba9f8'] = {"dfnID": "0e3ba9f8", "url": "https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active", "dfnText": "fully active", "refSections": [{"refs": [{"id": "ref-for-fully-active"}, {"id": "ref-for-fully-active\u2460"}, {"id": "ref-for-fully-active\u2461"}], "title": "1. Introduction"}, {"refs": [{"id": "ref-for-fully-active\u2462"}, {"id": "ref-for-fully-active\u2463"}], "title": "2. When should features care about BFCache?"}, {"refs": [{"id": "ref-for-fully-active\u2464"}, {"id": "ref-for-fully-active\u2465"}, {"id": "ref-for-fully-active\u2466"}, {"id": "ref-for-fully-active\u2467"}, {"id": "ref-for-fully-active\u2468"}, {"id": "ref-for-fully-active\u2460\u24ea"}, {"id": "ref-for-fully-active\u2460\u2460"}, {"id": "ref-for-fully-active\u2460\u2461"}], "title": "2.1.1. Gate actions with fully active checks"}, {"refs": [{"id": "ref-for-fully-active\u2460\u2462"}, {"id": "ref-for-fully-active\u2460\u2463"}, {"id": "ref-for-fully-active\u2460\u2464"}, {"id": "ref-for-fully-active\u2460\u2465"}, {"id": "ref-for-fully-active\u2460\u2466"}, {"id": "ref-for-fully-active\u2460\u2467"}, {"id": "ref-for-fully-active\u2460\u2468"}, {"id": "ref-for-fully-active\u2461\u24ea"}, {"id": "ref-for-fully-active\u2461\u2460"}, {"id": "ref-for-fully-active\u2461\u2461"}, {"id": "ref-for-fully-active\u2461\u2462"}, {"id": "ref-for-fully-active\u2461\u2463"}, {"id": "ref-for-fully-active\u2461\u2464"}, {"id": "ref-for-fully-active\u2461\u2465"}, {"id": "ref-for-fully-active\u2461\u2466"}, {"id": "ref-for-fully-active\u2461\u2467"}, {"id": "ref-for-fully-active\u2461\u2468"}, {"id": "ref-for-fully-active\u2462\u24ea"}, {"id": "ref-for-fully-active\u2462\u2460"}, {"id": "ref-for-fully-active\u2462\u2461"}, {"id": "ref-for-fully-active\u2462\u2462"}, {"id": "ref-for-fully-active\u2462\u2463"}], "title": "2.1.2. Listen for changes to fully active status"}, {"refs": [{"id": "ref-for-fully-active\u2462\u2464"}, {"id": "ref-for-fully-active\u2462\u2465"}, {"id": "ref-for-fully-active\u2462\u2466"}, {"id": "ref-for-fully-active\u2462\u2467"}, {"id": "ref-for-fully-active\u2462\u2468"}, {"id": "ref-for-fully-active\u2463\u24ea"}], "title": "2.1.3. Omit non-fully active documents from APIs that span multiple documents"}, {"refs": [{"id": "ref-for-fully-active\u2463\u2460"}, {"id": "ref-for-fully-active\u2463\u2461"}, {"id": "ref-for-fully-active\u2463\u2462"}, {"id": "ref-for-fully-active\u2463\u2463"}], "title": "2.1.4. Discard non-fully active documents for situations that can\u2019t be supported"}, {"refs": [{"id": "ref-for-fully-active\u2463\u2464"}], "title": "2.1.5. Be aware that per-document state/data might persist after navigation"}, {"refs": [{"id": "ref-for-fully-active\u2463\u2465"}], "title": "2.1.6. Be aware that navigations can happen between steps running in parallel"}], "external": true};
window.dfnpanelData['a72449dd'] = {"dfnID": "a72449dd", "url": "https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel", "dfnText": "in parallel", "refSections": [{"refs": [{"id": "ref-for-in-parallel"}, {"id": "ref-for-in-parallel\u2460"}, {"id": "ref-for-in-parallel\u2461"}, {"id": "ref-for-in-parallel\u2462"}, {"id": "ref-for-in-parallel\u2463"}], "title": "2.1.6. Be aware that navigations can happen between steps running in parallel"}], "external": true};
window.dfnpanelData['cbe46402'] = {"dfnID": "cbe46402", "url": "https://html.spec.whatwg.org/multipage/nav-history-apis.html#dom-opener", "dfnText": "opener", "refSections": [{"refs": [{"id": "ref-for-dom-opener"}], "title": "2.1.3. Omit non-fully active documents from APIs that span multiple documents"}], "external": true};
window.dfnpanelData['324be8d3'] = {"dfnID": "324be8d3", "url": "https://html.spec.whatwg.org/multipage/indices.html#event-pagehide", "dfnText": "pagehide", "refSections": [{"refs": [{"id": "ref-for-event-pagehide"}], "title": "2.1.2. Listen for changes to fully active status"}], "external": true};
window.dfnpanelData['e5ed7762'] = {"dfnID": "e5ed7762", "url": "https://html.spec.whatwg.org/multipage/indices.html#event-pageshow", "dfnText": "pageshow", "refSections": [{"refs": [{"id": "ref-for-event-pageshow"}], "title": "2.1.2. Listen for changes to fully active status"}], "external": true};
window.dfnpanelData['e93b877c'] = {"dfnID": "e93b877c", "url": "https://html.spec.whatwg.org/multipage/browsing-the-web.html#reactivate-a-document", "dfnText": "reactivate", "refSections": [{"refs": [{"id": "ref-for-reactivate-a-document"}], "title": "2.1.2. Listen for changes to fully active status"}], "external": true};
window.dfnpanelData['ca96a59c'] = {"dfnID": "ca96a59c", "url": "https://html.spec.whatwg.org/multipage/interaction.html#sticky-activation", "dfnText": "sticky activation", "refSections": [{"refs": [{"id": "ref-for-sticky-activation"}], "title": "2.1.5. Be aware that per-document state/data might persist after navigation"}], "external": true};
window.dfnpanelData['124a994b'] = {"dfnID": "124a994b", "url": "https://html.spec.whatwg.org/multipage/interaction.html#system-focus", "dfnText": "system focus", "refSections": [{"refs": [{"id": "ref-for-system-focus"}], "title": "2.1.1. Gate actions with fully active checks"}], "external": true};
window.dfnpanelData['4411082c'] = {"dfnID": "4411082c", "url": "https://html.spec.whatwg.org/multipage/document-lifecycle.html#unloading-document-cleanup-steps", "dfnText": "unloading document cleanup steps", "refSections": [{"refs": [{"id": "ref-for-unloading-document-cleanup-steps"}], "title": "2.1.2. Listen for changes to fully active status"}], "external": true};
window.dfnpanelData['723fc9da'] = {"dfnID": "723fc9da", "url": "https://w3c.github.io/ServiceWorker/#dom-clients-claim", "dfnText": "claim()", "refSections": [{"refs": [{"id": "ref-for-dom-clients-claim"}], "title": "2.1.4. Discard non-fully active documents for situations that can\u2019t be supported"}], "external": true};
window.dfnpanelData['be123ea4'] = {"dfnID": "be123ea4", "url": "https://w3c.github.io/ServiceWorker/#dom-clients-matchall", "dfnText": "matchAll()", "refSections": [{"refs": [{"id": "ref-for-dom-clients-matchall"}, {"id": "ref-for-dom-clients-matchall\u2460"}], "title": "2.1.3. Omit non-fully active documents from APIs that span multiple documents"}], "external": true};
</script>
<script>/* Boilerplate: script-dom-helper */
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}
</script>